<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fireworks Pro</title>
<style>
  body,html{
    margin:0;
    padding:0;
    overflow:hidden;
    background:black;
  }
  canvas{display:block;}
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<script>
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

function resize(){
  canvas.width=window.innerWidth;
  canvas.height=window.innerHeight;
}
resize();
window.addEventListener("resize",resize);

let particles=[];
let rockets=[];

// ================= PERFORMANCE =================

const MAX_PARTICLES=2500;
let particleMultiplier=1;
let lastFrame=performance.now();
let fps=60;

function updateFPS(){
  const now=performance.now();
  fps=1000/(now-lastFrame);
  lastFrame=now;

  if(fps<45) particleMultiplier=0.5;
  else if(fps<55) particleMultiplier=0.8;
  else particleMultiplier=1;
}

// ================= UTIL =================

function randomColor(){
  return `hsl(${Math.random()*360},100%,60%)`;
}

// ================= PARTICLE =================

class Particle{
  constructor(x,y,vx,vy,color){
    this.x=x;
    this.y=y;
    this.vx=vx;
    this.vy=vy;
    this.alpha=1;
    this.decay=0.015;
    this.color=color;
    this.size=4;
  }

  update(){
    this.vy+=0.03;
    this.x+=this.vx;
    this.y+=this.vy;
    this.alpha-=this.decay;
  }

  draw(){
    if(this.alpha<=0)return;

    const g=ctx.createRadialGradient(
      this.x,this.y,0,
      this.x,this.y,this.size
    );
    g.addColorStop(0,this.color);
    g.addColorStop(1,"transparent");

    ctx.globalAlpha=this.alpha;
    ctx.fillStyle=g;
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.size,0,Math.PI*2);
    ctx.fill();
    ctx.globalAlpha=1;
  }
}

// ================= ROCKET =================

class Rocket{
  constructor(targetX,targetY){
    this.x=canvas.width/2;
    this.y=canvas.height;

    const dx=targetX-this.x;
    const dy=targetY-this.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    const speed=8;

    this.vx=dx/dist*speed;
    this.vy=dy/dist*speed;

    this.targetX=targetX;
    this.targetY=targetY;
    this.exploded=false;
  }

  update(){
    this.x+=this.vx;
    this.y+=this.vy;

    const dx=this.targetX-this.x;
    const dy=this.targetY-this.y;

    if(!this.exploded && Math.sqrt(dx*dx+dy*dy)<10){
      this.exploded=true;
      explode(this.x,this.y);
    }
  }

  draw(){
    ctx.fillStyle="white";
    ctx.beginPath();
    ctx.arc(this.x,this.y,3,0,Math.PI*2);
    ctx.fill();
  }
}

// ================= EXPLOSION =================

function explode(x,y){

  if(particles.length>MAX_PARTICLES) return;

  const count=Math.floor(100*particleMultiplier);

  for(let i=0;i<count;i++){
    const a=Math.random()*Math.PI*2;
    const s=Math.random()*4+2;
    particles.push(
      new Particle(
        x,y,
        Math.cos(a)*s,
        Math.sin(a)*s,
        randomColor()
      )
    );
  }
}

// ================= SPAWN LOGIC =================

let lastClickTime=0;
let lastHoverTime=0;

function spawn(x,y){
  rockets.push(new Rocket(x,y));
}

// CLICK – ưu tiên cao nhất
canvas.addEventListener("click",e=>{
  lastClickTime=performance.now();

  const burst=Math.random()<0.5?2:1;

  for(let i=0;i<burst;i++){
    spawn(
      e.clientX+(Math.random()-0.5)*15,
      e.clientY+(Math.random()-0.5)*15
    );
  }
});

// HOVER – 2s / phát
let hoverX=null,hoverY=null;

canvas.addEventListener("mousemove",e=>{
  hoverX=e.clientX;
  hoverY=e.clientY;
});

setInterval(()=>{
  if(!hoverX) return;

  lastHoverTime=performance.now();
  spawn(hoverX,hoverY);

},2000);

// RANDOM – chỉ khi không click/hover gần đây
setInterval(()=>{

  const now=performance.now();

  const clickRecent=(now-lastClickTime)<1500;
  const hoverRecent=(now-lastHoverTime)<1500;

  if(clickRecent || hoverRecent) return;

  // nếu FPS thấp thì giảm random
  if(fps<50) return;

  const burst=Math.random()<0.25?3:(Math.random()<0.5?2:1);

  for(let i=0;i<burst;i++){
    spawn(
      Math.random()*canvas.width,
      Math.random()*canvas.height*0.6
    );
  }

},1200);

// ================= LOOP =================

function animate(){
  updateFPS();

  ctx.globalCompositeOperation="destination-out";
  ctx.fillStyle="rgba(0,0,0,0.15)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.globalCompositeOperation="lighter";

  for(let i=rockets.length-1;i>=0;i--){
    rockets[i].update();
    rockets[i].draw();
    if(rockets[i].exploded) rockets.splice(i,1);
  }

  for(let i=particles.length-1;i>=0;i--){
    particles[i].update();
    particles[i].draw();
    if(particles[i].alpha<=0) particles.splice(i,1);
  }

  requestAnimationFrame(animate);
}

animate();
</script>
</body>
</html>
