<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smooth Fireworks</title>
<style>
  body, html {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: black;
  }
  canvas { display:block; }
</style>
</head>
<body>
<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

let particles = [];
let rockets = [];

const MAX_PARTICLES = 2000;
const MAX_ROCKETS = 80;

let clickQueue = [];
let lastClickTime = 0;
let lastMoveShot = 0;
let lastRandomShot = 0;
let lastMoveTime = 0;

const RANDOM_INTERVAL = 900;
const MOVE_INTERVAL = 2000;
const CLICK_SPAM_THRESHOLD = 400;

// ================= COLOR UTILS =================

function randomColor(){
  return `hsl(${Math.random()*360},100%,60%)`;
}

function monoVariant(h){
  const shift = (Math.random()-0.5)*30;
  return `hsl(${h+shift},100%,60%)`;
}

// ================= PARTICLE =================

class Particle {
  constructor(x,y,vx,vy,color,decay=0.015,size=4){
    this.x = x;
    this.y = y;
    this.vx = vx;
    this.vy = vy;
    this.alpha = 1;
    this.decay = decay;
    this.color = color;
    this.size = size;
    this.split = false;
  }

  update(){
    this.vy += 0.03;
    this.x += this.vx;
    this.y += this.vy;
    this.alpha -= this.decay;

    if(this.split && this.alpha < 0.5){
      this.split = false;
      for(let i=0;i<4;i++){
        const angle = i * (Math.PI/2);
        particles.push(new Particle(
          this.x,this.y,
          Math.cos(angle)*2,
          Math.sin(angle)*2,
          this.color,
          0.02,
          2
        ));
      }
    }
  }

  draw(){
    if(this.alpha <= 0) return;

    const g = ctx.createRadialGradient(
      this.x,this.y,0,
      this.x,this.y,this.size
    );

    g.addColorStop(0,this.color);
    g.addColorStop(1,"transparent");

    ctx.globalAlpha = this.alpha;
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.size,0,Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;
  }
}

// ================= ROCKET =================

class Rocket {
  constructor(type,targetX,targetY){

    // random trong ±20px ở đáy giữa
    this.x = canvas.width/2 + (Math.random()-0.5)*200;
    this.y = canvas.height;

    this.targetX = targetX;
    this.targetY = targetY;

    const dx = targetX - this.x;
    const dy = targetY - this.y;
    const dist = Math.sqrt(dx*dx + dy*dy);

    const speed = 10;
    this.vx = dx / dist * speed;
    this.vy = dy / dist * speed;

    this.type = type;
    this.exploded = false;

    // màu trail random
    this.trailColor = randomColor();
  }

  update(){
    this.x += this.vx;
    this.y += this.vy;

    if(
      (this.vy <= 0 && this.y <= this.targetY) ||
      Math.abs(this.y - this.targetY) < 6
    ){
      if(!this.exploded){
        this.exploded = true;
        explode(this.x,this.y,this.type);
      }
    }
  }

  draw(){
    ctx.fillStyle = this.trailColor;
    ctx.beginPath();
    ctx.arc(this.x,this.y,1.5,0,Math.PI*2); // nhỏ lại
    ctx.fill();
  }
}

// ================= EXPLOSIONS =================

function explode(x,y,type){

  switch(type){

    case 0:
      for(let i=0;i<100;i++){
        const a=Math.random()*Math.PI*2;
        const s=Math.random()*4+2;
        particles.push(new Particle(x,y,Math.cos(a)*s,Math.sin(a)*s,randomColor()));
      }
    break;

    case 1:
      for(let i=0;i<120;i++){
        const a=Math.random()*Math.PI*2;
        const s=Math.random()*3+1.5;
        particles.push(new Particle(x,y,Math.cos(a)*s*1.2,Math.sin(a)*s*0.8,monoVariant(0),0.008,4));
      }
    break;

    case 2:
      for(let i=0;i<80;i++){
        const a=(Math.PI*2/80)*i;
        particles.push(new Particle(x,y,Math.cos(a)*3.5,Math.sin(a)*3.5,monoVariant(180),0.02,3));
      }
    break;

    case 3:
      for(let i=0;i<100;i++){
        const a=(Math.PI*2/100)*i;
        const s=(i%2===0)?3:5;
        particles.push(new Particle(x,y,Math.cos(a)*s,Math.sin(a)*s,randomColor(),0.018,3));
      }
    break;

    case 4:
      for(let i=0;i<5;i++){
        const base=i*(Math.PI*2/5);
        for(let j=0;j<25;j++){
          particles.push(new Particle(x,y,Math.cos(base)*j*0.2,Math.sin(base)*j*0.2,monoVariant(30)));
        }
      }
    break;

    case 5:
      for(let i=0;i<120;i++){
        const a=i*0.15;
        const s=i*0.03;
        particles.push(new Particle(x,y,Math.cos(a)*s,Math.sin(a)*s,monoVariant(300)));
      }
    break;

    case 6:
      for(let i=0;i<130;i++){
        const a=Math.random()*Math.PI*2;
        const s=Math.random()*3+2;
        particles.push(new Particle(x,y,Math.cos(a)*s,Math.sin(a)*s-2,monoVariant(50),0.007,5));
      }
    break;

    case 7:
      for(let i=0;i<60;i++){
        const a=Math.random()*Math.PI*2;
        const s=Math.random()*4+2;
        const p=new Particle(x,y,Math.cos(a)*s,Math.sin(a)*s,randomColor());
        p.split=true;
        particles.push(p);
      }
    break;

    case 8:
      for(let i=0;i<100;i++){
        const t=Math.PI*2*i/100;
        const scale=0.2;
        const vx=scale*16*Math.pow(Math.sin(t),3);
        const vy=-scale*(13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t));
        particles.push(new Particle(x,y,vx,vy,monoVariant(0)));
      }
    break;
  }
}

// ================= SPAWN + CONTROL =================

function spawnRocket(x,y){
  if(rockets.length > MAX_ROCKETS) return;
  if(particles.length > MAX_PARTICLES) return;
  const type = Math.floor(Math.random()*9);
  rockets.push(new Rocket(type,x,y));
}

let mouseX = canvas.width/2;
let mouseY = canvas.height/2;

document.addEventListener("mousemove",e=>{
  mouseX = e.clientX;
  mouseY = e.clientY;
  lastMoveTime = performance.now();
});

canvas.addEventListener("click",e=>{
  clickQueue.push({x:e.clientX,y:e.clientY});
  lastClickTime = performance.now();
});

function control(now){

  const clickSpam = (now - lastClickTime) < CLICK_SPAM_THRESHOLD;

  if(clickQueue.length > 0){
    const p = clickQueue.shift();
    spawnRocket(p.x,p.y);
    return;
  }

  if(now - lastMoveShot > MOVE_INTERVAL && (now - lastMoveTime) < 3000){
    spawnRocket(mouseX,mouseY);
    lastMoveShot = now;
  }

  if(!clickSpam && now - lastRandomShot > RANDOM_INTERVAL){
    const rx = Math.random()*canvas.width;
    const ry = Math.random()*canvas.height*0.6;
    spawnRocket(rx,ry);
    lastRandomShot = now;
  }
}

function animate(now){

  control(now);

  ctx.globalCompositeOperation="destination-out";
  ctx.fillStyle="rgba(0,0,0,0.15)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.globalCompositeOperation="lighter";

  for(let i=rockets.length-1;i>=0;i--){
    rockets[i].update();
    rockets[i].draw();
    if(rockets[i].exploded) rockets.splice(i,1);
  }

  for(let i=particles.length-1;i>=0;i--){
    particles[i].update();
    particles[i].draw();
    if(particles[i].alpha<=0) particles.splice(i,1);
  }

  requestAnimationFrame(animate);
}

requestAnimationFrame(animate);
</script>
</body>
</html>
