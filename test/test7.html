<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ASCII Donut 3D Proper Scale</title>
<style>
  body, html {margin:0; padding:0; overflow:hidden; background:#000; font-family:monospace; color:#0f0;}
  canvas {display:block;}
</style>
</head>
<body>
<canvas id="donut"></canvas>
<script>
const canvas = document.getElementById('donut');
const ctx = canvas.getContext('2d');

const R1 = 1;
const R2 = 2;
const K2 = 5;
const theta_spacing = 0.07;
const phi_spacing = 0.02;
const luminance_chars = ".,-~:;=!*#$@";

let width, height;
let screen_width, screen_height;
let K1;

let A = 0, B = 0;

function resize(){
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;

    // Lấy chiều nhỏ nhất của canvas
    const minDim = Math.min(width, height);

    // Đặt số ký tự theo chiều nhỏ nhất
    screen_width = Math.floor(minDim / 10); // càng lớn minDim, càng nhiều ký tự
    screen_height = screen_width; // giữ vuông cho donut

    // Scale K1 theo minDim
    K1 = screen_width * K2 * 3 / (8*(R1+R2));

    ctx.font = `${Math.floor(minDim / screen_width)}px monospace`;
}

resize();
window.addEventListener('resize', resize);

function render_frame(){
    const output = [];
    const zbuffer = [];
    for(let i=0;i<screen_width;i++){
        output[i] = [];
        zbuffer[i] = [];
        for(let j=0;j<screen_height;j++){
            output[i][j] = ' ';
            zbuffer[i][j] = 0;
        }
    }

    const cosA = Math.cos(A), sinA = Math.sin(A);
    const cosB = Math.cos(B), sinB = Math.sin(B);

    for(let theta=0; theta < 2*Math.PI; theta+=theta_spacing){
        const costheta = Math.cos(theta), sintheta = Math.sin(theta);
        for(let phi=0; phi < 2*Math.PI; phi+=phi_spacing){
            const cosphi = Math.cos(phi), sinphi = Math.sin(phi);

            const circlex = R2 + R1*costheta;
            const circley = R1*sintheta;

            const x = circlex*(cosB*cosphi + sinA*sinB*sinphi) - circley*cosA*sinB;
            const y = circlex*(sinB*cosphi - sinA*cosB*sinphi) + circley*cosA*cosB;
            const z = K2 + cosA*circlex*sinphi + circley*sinA;
            const ooz = 1/z;

            const xp = Math.floor(screen_width/2 + K1*ooz*x);
            const yp = Math.floor(screen_height/2 - K1*ooz*y);

            const L = cosphi*costheta*sinB - cosA*costheta*sinphi - sinA*sintheta + cosB*(cosA*sintheta - costheta*sinA*sinphi);
            if(L>0 && xp >=0 && xp<screen_width && yp>=0 && yp<screen_height){
                if(ooz > zbuffer[xp][yp]){
                    zbuffer[xp][yp] = ooz;
                    const luminance_index = Math.floor(L*8);
                    output[xp][yp] = luminance_chars[luminance_index > 11 ? 11 : luminance_index];
                }
            }
        }
    }

    ctx.fillStyle = "#000";
    ctx.fillRect(0,0,width,height);
    ctx.fillStyle = "#0f0";

    const charWidth = width/screen_width;
    const charHeight = height/screen_height;
    for(let j=0;j<screen_height;j++){
        for(let i=0;i<screen_width;i++){
            ctx.fillText(output[i][j], i*charWidth, j*charHeight);
        }
    }

    A += 0.03;
    B += 0.01;
    requestAnimationFrame(render_frame);
}

render_frame();
</script>
</body>
</html>
